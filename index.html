<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Hand & Foot ‚Äî Multiplayer</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
<style>
:root{
  --bg1:#0A1210;--bg2:#132B18;--bg3:#0D1F12;--felt-glow:rgba(34,80,34,.25);
  --accent:#EAB308;--accent-dim:rgba(234,179,8,.12);--accent-border:rgba(234,179,8,.25);--accent-dark:#CA8A04;--accent-text:#1A1A0A;
  --panel:rgba(0,0,0,.4);--panel-border:rgba(234,179,8,.18);
  --text:#E2D9C0;--text-dim:#8A9A7A;--text-muted:#5E6E52;--text-label:#C4B98B;
  --card-bg:#FFFDF5;--card-border:#D1C9B8;--card-sel-bg:#FFF9E0;--card-sel-border:#F59E0B;
  --success:#22C55E;--danger:#EF4444;--info:#3B82F6;--purple:#A78BFA;
  --font-display:'Playfair Display',Georgia,serif;--font-body:'DM Sans',system-ui,sans-serif;
  --card-w:clamp(64px,8.5vw,105px);--card-h:clamp(90px,12vw,148px);
  --card-w-sm:clamp(42px,5vw,62px);--card-h-sm:clamp(59px,7vw,87px);
  --card-font:clamp(14px,1.8vw,22px);--card-suit:clamp(22px,3.2vw,38px);
  --card-font-sm:clamp(10px,1.3vw,15px);--card-suit-sm:clamp(15px,2.2vw,26px);
  --card-back-img:none;
}
.theme-vegas{--bg1:#12051A;--bg2:#1F0A30;--bg3:#0D0415;--felt-glow:rgba(180,40,200,.15);--accent:#FF3CAC;--accent-dim:rgba(255,60,172,.14);--accent-border:rgba(255,60,172,.3);--accent-dark:#CC2E8A;--accent-text:#fff;--panel-border:rgba(255,60,172,.2);--text:#F0E6FF;--text-dim:#B08AD0;--text-muted:#7A5A9A;--text-label:#D4A0F0}
.theme-royal{--bg1:#060C18;--bg2:#0C1A34;--bg3:#081020;--felt-glow:rgba(40,70,160,.2);--accent:#A0C4FF;--accent-dim:rgba(160,196,255,.12);--accent-border:rgba(160,196,255,.25);--accent-dark:#6A9AE0;--accent-text:#0A1428;--panel-border:rgba(160,196,255,.18);--text:#D8E4F8;--text-dim:#7A98C4;--text-muted:#4A6A94;--text-label:#A8C0E0}
.theme-crimson{--bg1:#140808;--bg2:#2A1010;--bg3:#1A0A0A;--felt-glow:rgba(160,30,30,.2);--accent:#FFB347;--accent-dim:rgba(255,179,71,.12);--accent-border:rgba(255,179,71,.25);--accent-dark:#E09530;--accent-text:#1A0A00;--panel-border:rgba(255,179,71,.18);--text:#F0DDD0;--text-dim:#C09A7A;--text-muted:#8A6A50;--text-label:#D4B090}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;overflow:hidden}
body{font-family:var(--font-body);background:linear-gradient(160deg,var(--bg1),var(--bg2),var(--bg3));color:var(--text);-webkit-tap-highlight-color:transparent}
button{font-family:var(--font-body);cursor:pointer;outline:none}input{font-family:var(--font-body);outline:none}
.screen{display:none;height:100vh;height:100dvh;flex-direction:column}.screen.active{display:flex}
.felt-glow{position:fixed;inset:0;pointer-events:none;background:radial-gradient(ellipse at center,var(--felt-glow),transparent 70%)}
.btn{padding:10px 22px;border-radius:10px;font-size:13px;font-weight:600;letter-spacing:.3px;transition:all .15s;border:1.5px solid var(--accent-border);background:var(--accent-dim);color:var(--accent)}
.btn:disabled{opacity:.35;cursor:default}.btn:active:not(:disabled){transform:scale(.97)}
.btn-gold{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:var(--accent-text);border:none;box-shadow:0 4px 20px rgba(0,0,0,.25)}
.btn-green{background:linear-gradient(135deg,#22C55E,#16A34A);color:#fff;border:none}
.btn-red{background:linear-gradient(135deg,#EF4444,#DC2626);color:#fff;border:none}
.btn-ghost{background:rgba(255,255,255,.05);color:#94A3B8;border:1px solid rgba(255,255,255,.12)}
.btn-sm{padding:6px 14px;font-size:12px}
/* Cards */
.card{width:var(--card-w);height:var(--card-h);border-radius:8px;flex-shrink:0;position:relative;display:flex;flex-direction:column;padding:4px 6px;user-select:none;transition:transform .15s,box-shadow .15s;cursor:pointer;background:var(--card-bg);border:1.5px solid var(--card-border);box-shadow:0 2px 8px rgba(0,0,0,.18)}
.card.selected{background:var(--card-sel-bg);border-color:var(--card-sel-border);border-width:2.5px;transform:translateY(-6px);box-shadow:0 0 14px rgba(245,158,11,.5),0 6px 16px rgba(0,0,0,.25)}
.card.must-play{box-shadow:0 0 12px rgba(239,68,68,.6),0 4px 12px rgba(0,0,0,.2);border-color:var(--danger);border-width:2.5px}
.card.new-card{animation:newGlow 1.5s ease-in-out 2;border-color:var(--accent);border-width:2.5px}
@keyframes newGlow{0%{box-shadow:0 0 4px rgba(234,179,8,.2)}50%{box-shadow:0 0 22px rgba(234,179,8,.7),0 0 44px rgba(234,179,8,.3)}100%{box-shadow:0 0 4px rgba(234,179,8,.2)}}
.card-rank{font-size:var(--card-font);font-weight:700;line-height:1;font-family:var(--font-display)}
.card-suit-sm{font-size:calc(var(--card-font)*.75);line-height:1}
.card-suit-lg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:var(--card-suit);opacity:.8}
.card.sm{width:var(--card-w-sm);height:var(--card-h-sm);padding:2px 3px;cursor:default}
.card.sm .card-rank{font-size:var(--card-font-sm)}.card.sm .card-suit-sm{font-size:calc(var(--card-font-sm)*.75)}.card.sm .card-suit-lg{font-size:var(--card-suit-sm)}
.card-back{width:var(--card-w);height:var(--card-h);border-radius:8px;flex-shrink:0;background:var(--card-back-img),linear-gradient(135deg,#1E3A5F,#0F2440);background-size:cover;background-position:center;border:2px solid #2A5080;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.3);overflow:hidden}
.card-back-inner{width:70%;height:75%;border-radius:4px;border:1.5px solid #3A6090;background:repeating-linear-gradient(45deg,transparent,transparent 3px,rgba(58,96,144,.3) 3px,rgba(58,96,144,.3) 6px)}
.card-back.has-img .card-back-inner{display:none}
.card-back.sm{width:var(--card-w-sm);height:var(--card-h-sm)}.card-back.clickable{cursor:pointer}.card-back.hl{border-color:var(--success);box-shadow:0 0 10px rgba(34,197,94,.3)}
/* Home/Lobby */
#home,#lobby{align-items:center;justify-content:center;padding:20px;overflow-y:auto}
.home-box,.lobby-box{background:var(--panel);border-radius:22px;padding:clamp(24px,4vw,40px);max-width:500px;width:100%;border:1px solid var(--panel-border);box-shadow:0 24px 80px rgba(0,0,0,.5)}
.home-logo{text-align:center;margin-bottom:24px}.home-logo .icon{font-size:clamp(36px,7vw,52px)}.home-logo h1{font-family:var(--font-display);font-size:clamp(22px,5vw,30px);color:var(--accent)}.home-logo .sub{color:var(--text-muted);font-size:13px;margin-top:4px}
.field{margin-bottom:16px}.field label{color:var(--text-label);font-size:12px;font-weight:600;display:block;margin-bottom:4px}
.field input{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:9px;padding:10px 14px;color:var(--text);font-size:15px}
.code-input{font-size:22px!important;font-family:monospace!important;letter-spacing:6px;text-align:center;text-transform:uppercase;color:var(--accent)!important}
.num-row{display:flex;gap:6px;flex-wrap:wrap}
.num-btn{width:42px;height:42px;border-radius:8px;font-size:16px;font-weight:700;font-family:var(--font-display);transition:all .12s;background:rgba(255,255,255,.03);color:#64748B;border:1.5px solid rgba(255,255,255,.08)}
.num-btn.active{background:var(--accent-dim);color:var(--accent);border-color:var(--accent)}
.theme-row{display:flex;gap:6px;flex-wrap:wrap}
.theme-btn{flex:1;min-width:80px;padding:8px 4px;border-radius:10px;text-align:center;font-size:10px;font-weight:600;cursor:pointer;transition:all .15s;border:2px solid rgba(255,255,255,.06);background:rgba(255,255,255,.03);color:#94A3B8}
.theme-btn.active{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.theme-btn .swatch{width:100%;height:14px;border-radius:4px;margin-bottom:3px}
.home-actions{display:flex;gap:10px;margin-top:4px}.home-actions .btn{flex:1;font-size:15px;padding:14px 0}
.error-msg{margin-top:12px;color:#FCA5A5;font-size:13px;text-align:center;background:rgba(239,68,68,.1);padding:8px 12px;border-radius:8px}
.back-link{display:block;text-align:center;margin-top:10px;background:none;border:none;color:#64748B;font-size:12px}
.anim-in{animation:fadeIn .2s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.lobby-box{text-align:center}
.code-display{cursor:pointer;background:var(--accent-dim);border:2px dashed var(--accent-border);border-radius:14px;padding:16px;margin-bottom:18px}
.code-display .code{font-size:clamp(26px,5.5vw,36px);font-weight:700;color:var(--accent);font-family:monospace;letter-spacing:8px}
.code-display .hint{font-size:11px;color:var(--text-muted);margin-top:3px}
.player-list{text-align:left;margin-bottom:20px}.player-list .label{color:var(--text-label);font-size:12px;font-weight:600;margin-bottom:6px}
.player-slot{display:flex;align-items:center;gap:10px;border-radius:9px;padding:9px 12px;margin-bottom:5px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)}
.player-slot.me{border-color:var(--accent-border)}.player-slot.empty{border-style:dashed}
.player-avatar{width:30px;height:30px;border-radius:15px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:700;font-family:var(--font-display)}
.conn-status{font-size:12px;padding:5px 12px;border-radius:8px;margin-bottom:14px;display:inline-block}
.conn-ok{background:rgba(34,197,94,.1);color:var(--success)}.conn-wait{background:var(--accent-dim);color:var(--accent)}
/* Game */
#game{overflow:hidden}
.top-bar{display:flex;align-items:center;justify-content:space-between;padding:6px 12px;background:rgba(0,0,0,.35);border-bottom:1px solid var(--panel-border);flex-wrap:wrap;gap:4px;flex-shrink:0}
.top-bar .title{color:var(--accent);font-size:14px;font-weight:700;font-family:var(--font-display)}
.badge{display:inline-block;padding:2px 9px;border-radius:16px;font-size:11px;font-weight:600}
.badge-accent{background:var(--accent-dim);color:var(--accent)}.badge-code{background:rgba(255,255,255,.05);color:#94A3B8}.badge-code strong{color:var(--accent);font-family:monospace}
.top-btns{display:flex;gap:4px}
/* Turn Banner - prominent */
.turn-banner{padding:10px 16px;text-align:center;flex-shrink:0;border-bottom:2px solid rgba(255,255,255,.06);transition:background .3s;background:rgba(0,0,0,.2)}
.turn-banner.mine{background:linear-gradient(135deg,rgba(234,179,8,.15),rgba(234,179,8,.05));border-color:var(--accent-border)}
.turn-banner .who{font-size:18px;font-weight:700;font-family:var(--font-display)}
.turn-banner .phase{margin-left:12px;font-size:14px;font-weight:600}
.turn-banner .last{font-size:12px;color:var(--text-dim);margin-top:3px;max-width:100%;overflow:hidden;text-overflow:ellipsis}
/* Activity log */
.activity-log{position:absolute;top:0;right:0;width:260px;max-height:200px;overflow-y:auto;background:rgba(0,0,0,.8);border-radius:0 0 0 12px;border-left:1px solid var(--panel-border);border-bottom:1px solid var(--panel-border);padding:8px 10px;font-size:11px;color:var(--text-dim);z-index:10;display:none}
.activity-log.visible{display:block}
.activity-log .log-entry{padding:2px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.activity-log .log-entry:last-child{border:none}
/* Player tabs with scores */
.player-tabs{display:flex;gap:3px;padding:4px 12px;overflow-x:auto;flex-shrink:0}
.ptab{padding:5px 10px;border-radius:7px;white-space:nowrap;display:flex;align-items:center;gap:5px;font-size:11px;flex-shrink:0;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);color:var(--text-muted)}
.ptab.current{background:var(--accent-dim);border-color:var(--accent);color:var(--accent);font-weight:700}
.ptab.me{border-color:var(--accent-border);color:var(--text-dim)}
.ptab .pts{font-size:10px;opacity:.7;font-weight:400}
.ptab .cnt{font-size:9px;color:#64748B}
.game-scroll{flex:1;overflow-y:auto;overflow-x:hidden;position:relative}
.piles-area{display:flex;gap:clamp(8px,1.5vw,14px);padding:8px 12px;flex-wrap:wrap;align-items:flex-start}
.pile-col{text-align:center}.pile-label{color:var(--text-muted);font-size:10px;margin-bottom:3px;font-weight:600}
.pile-hint{font-size:9px;margin-top:3px;font-weight:600}.pile-hint.green{color:var(--success)}.pile-hint.blue{color:var(--info)}.pile-hint.red{color:var(--danger)}
.empty-pile{width:var(--card-w);height:var(--card-h);border-radius:8px;border:2px dashed rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;color:#3A4A30;font-size:10px}
.foot-active{width:var(--card-w);height:var(--card-h);border-radius:8px;border:2px solid var(--success);background:rgba(34,197,94,.08);display:flex;align-items:center;justify-content:center;font-size:24px}
.status-box{background:rgba(0,0,0,.2);border-radius:10px;padding:8px 12px;border:1px solid rgba(255,255,255,.06);min-width:120px}
.status-label{color:var(--text-dim);font-size:10px;font-weight:600;margin-bottom:3px}
.stat-row{display:flex;gap:5px;flex-wrap:wrap}.stat{font-size:10px;padding:2px 6px;border-radius:5px}
.stat-clean{color:#86EFAC;background:rgba(34,197,94,.1)}.stat-dirty{color:var(--purple);background:rgba(139,92,246,.1)}
.can-go-out{margin-top:4px;color:var(--accent);font-size:10px;font-weight:700;background:var(--accent-dim);padding:3px 7px;border-radius:5px;text-align:center;animation:pulse 1.5s infinite}
.must-meld-warn{margin-top:4px;color:#FCA5A5;font-size:10px;font-weight:600;background:rgba(239,68,68,.1);padding:3px 7px;border-radius:5px;text-align:center;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
/* Melds */
.melds-section{padding:4px 12px 6px}.melds-section .label{color:var(--text-dim);font-size:11px;font-weight:600;margin-bottom:3px}
.melds-row{display:flex;gap:8px;overflow-x:auto;padding-bottom:5px;cursor:grab}
.melds-row:active{cursor:grabbing}
.meld-card{background:rgba(255,255,255,.05);border-radius:10px;padding:6px 8px;border:1px solid rgba(255,255,255,.1);flex-shrink:0}
.meld-card.book-clean{background:rgba(234,179,8,.1);border:2px solid var(--accent)}
.meld-card.book-dirty{background:rgba(147,130,220,.1);border:2px solid #9382DC}
.meld-header{display:flex;align-items:center;gap:5px;margin-bottom:2px}
.meld-rank{font-size:12px;font-weight:700;font-family:var(--font-display)}.meld-count{font-size:10px;color:#64748B}
.meld-cards-row{display:flex}
.meld-add-btn{margin-top:4px;font-size:10px;background:var(--accent-dim);color:var(--accent);border:1px solid var(--accent-border);border-radius:5px;padding:2px 8px;font-weight:600}
/* Completed book - compact stack */
.book-stack{width:var(--card-w-sm);height:var(--card-h-sm);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;font-family:var(--font-display);position:relative;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.2)}
.book-stack.clean{background:linear-gradient(135deg,rgba(234,179,8,.2),rgba(234,179,8,.1));border:2px solid var(--accent);color:var(--accent)}
.book-stack.dirty{background:linear-gradient(135deg,rgba(147,130,220,.2),rgba(147,130,220,.1));border:2px solid #9382DC;color:var(--purple)}
.book-stack .bcount{position:absolute;bottom:2px;right:4px;font-size:8px;opacity:.7}
/* Opp melds */
.opp-melds{padding:4px 12px 6px}.opp-melds .label{color:var(--text-dim);font-size:11px;font-weight:600;margin-bottom:4px}
.opp-player-section{margin-bottom:8px}
.opp-player-name{color:var(--text-dim);font-size:12px;font-weight:600;margin-bottom:3px}
.opp-melds-scroll{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;cursor:grab}.opp-melds-scroll:active{cursor:grabbing}
.opp-meld-card{background:rgba(255,255,255,.05);border-radius:10px;padding:6px 8px;border:1px solid rgba(255,255,255,.1);flex-shrink:0}
.opp-meld-card.book-clean{background:rgba(234,179,8,.08);border:2px solid var(--accent)}
.opp-meld-card.book-dirty{background:rgba(147,130,220,.08);border:2px solid #9382DC}
.action-bar{display:flex;gap:6px;padding:4px 12px 4px;flex-wrap:wrap;flex-shrink:0}
.hand-section{background:rgba(0,0,0,.22);border-top:1px solid rgba(255,255,255,.06);padding:5px 12px 12px;flex-shrink:0}
.hand-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px;gap:6px}
.hand-label{color:var(--text-dim);font-size:11px;font-weight:600}.hand-sel{color:#64748B;font-size:10px}
.sort-btn{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:5px;padding:2px 8px;font-size:10px;color:#94A3B8;cursor:pointer}
.hand-fan{display:flex;overflow-x:auto;padding:5px 2px 3px;cursor:grab}.hand-fan:active{cursor:grabbing}
.hand-empty{color:var(--text-muted);font-size:13px;padding:14px 0;text-align:center}
/* Toast */
.toast{position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:200;background:rgba(0,0,0,.92);color:var(--accent);padding:12px 24px;border-radius:12px;font-size:14px;font-weight:600;border:1px solid var(--accent-border);box-shadow:0 8px 32px rgba(0,0,0,.5);max-width:90%;text-align:center;pointer-events:none;transition:opacity .3s}
.toast.hidden{opacity:0}
/* Big toast for foot pickup etc */
.big-toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:210;background:rgba(0,0,0,.92);color:var(--accent);padding:24px 40px;border-radius:18px;font-size:22px;font-weight:700;font-family:var(--font-display);border:2px solid var(--accent-border);box-shadow:0 16px 60px rgba(0,0,0,.6);text-align:center;pointer-events:none;transition:opacity .4s;opacity:0}
.big-toast.show{opacity:1}
/* Modals */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(6px);padding:16px}
.modal-overlay.hidden{display:none}
.modal-box{background:linear-gradient(160deg,var(--bg2),var(--bg3));border-radius:18px;padding:24px;max-width:640px;width:100%;border:1px solid var(--panel-border);max-height:88vh;overflow:auto}
.modal-title{color:var(--accent);font-size:20px;margin-bottom:12px;font-family:var(--font-display);text-align:center}
.rules-text{color:var(--text-label);font-size:12px;line-height:1.7}.rules-text p{margin-bottom:5px}.rules-text strong{color:var(--accent)}
.score-table{width:100%;border-collapse:collapse}
.score-table th{color:var(--text-label);font-size:12px;text-align:center;padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.08)}.score-table th:first-child{text-align:left}
.score-table td{padding:6px 8px;font-size:13px;border-bottom:1px solid rgba(255,255,255,.04);text-align:center}.score-table td:first-child{text-align:left}
/* Round recap */
.recap-section{margin-bottom:16px}.recap-player{margin-bottom:12px;background:rgba(255,255,255,.03);border-radius:10px;padding:10px 12px;border:1px solid rgba(255,255,255,.06)}
.recap-name{font-size:14px;font-weight:700;margin-bottom:6px}.recap-detail{font-size:12px;display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid rgba(255,255,255,.03)}
.recap-detail:last-child{border:none}
.recap-pos{color:#86EFAC}.recap-neg{color:#FCA5A5}.recap-total{font-size:15px;font-weight:700;color:var(--accent);margin-top:4px;text-align:right}
.gameover-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:90;backdrop-filter:blur(8px)}
.gameover-overlay.hidden{display:none}
/* Scrollbars */
::-webkit-scrollbar{height:8px;width:8px}::-webkit-scrollbar-track{background:rgba(0,0,0,.3);border-radius:4px}::-webkit-scrollbar-thumb{background:var(--accent);border-radius:4px;opacity:.6}::-webkit-scrollbar-thumb:hover{opacity:1}
</style>
</head>
<body>
<div class="felt-glow"></div>
<div id="toast" class="toast hidden"></div>
<div id="bigToast" class="big-toast"></div>
<div id="home" class="screen active">
  <div class="home-box">
    <div class="home-logo"><div class="icon">üÉè</div><h1>Hand &amp; Foot</h1><div class="sub">Multiplayer ‚Äî no accounts needed</div></div>
    <div class="field"><label>Your Name</label><input id="nameInput" maxlength="16" placeholder="Enter your name‚Ä¶"></div>
    <div id="homeButtons" class="home-actions">
      <button class="btn btn-gold" onclick="showHostOpts()">Create Game</button>
      <button class="btn" onclick="showJoinOpts()">Join Game</button>
    </div>
    <div id="hostOpts" class="anim-in" style="display:none">
      <div class="field"><label>Max Players</label><div class="num-row" id="playerBtns"></div></div>
      <div class="field"><label>Rounds</label><div class="num-row" id="roundBtns"></div></div>
      <div class="field"><label>Table Theme</label><div class="theme-row" id="themeBtns"></div></div>
      <div class="field"><label>Card Back Image URL <span style="font-weight:400;color:var(--text-muted)">(optional)</span></label><input id="cardBackInput" placeholder="https://example.com/image.png" style="font-size:13px"><div style="font-size:10px;color:var(--text-muted);margin-top:3px">Direct image link. Leave blank for default.</div></div>
      <button class="btn btn-gold" style="width:100%;font-size:15px;padding:13px 0" onclick="hostGame()">Create &amp; Get Code</button>
      <button class="back-link" onclick="showHomeBtns()">‚Üê Back</button>
    </div>
    <div id="joinOpts" class="anim-in" style="display:none">
      <div class="field"><label>Game Code</label><input id="codeInput" class="code-input" maxlength="6" placeholder="ABC123"></div>
      <button class="btn btn-gold" style="width:100%;font-size:15px;padding:13px 0" onclick="joinGame()">Join Game</button>
      <button class="back-link" onclick="showHomeBtns()">‚Üê Back</button>
    </div>
    <div id="homeError" class="error-msg" style="display:none"></div>
    <div style="margin-top:18px;padding:12px;background:rgba(255,255,255,.025);border-radius:9px;border:1px solid rgba(255,255,255,.05)"><p style="color:var(--text-muted);font-size:11px;line-height:1.5"><strong style="color:var(--text-dim)">üîí Peer-to-peer</strong> ‚Äî no server, no accounts, no tracking.</p></div>
  </div>
</div>
<div id="lobby" class="screen">
  <div class="lobby-box">
    <div style="font-size:32px;margin-bottom:6px">üÉè</div>
    <h2 style="color:var(--accent);font-size:20px;font-family:var(--font-display);margin-bottom:3px">Game Lobby</h2>
    <p style="color:var(--text-muted);font-size:12px;margin-bottom:14px">Share code with players</p>
    <div id="connStatus" class="conn-status conn-wait">Connecting‚Ä¶</div>
    <div class="code-display" onclick="copyCode()"><div class="code" id="lobbyCode"></div><div class="hint" id="copyHint">Tap to copy</div></div>
    <div class="player-list"><div class="label">PLAYERS <span id="playerCount"></span></div><div id="playerSlots"></div></div>
    <div style="display:flex;gap:10px">
      <button id="startBtn" class="btn btn-gold" style="flex:1;font-size:15px;padding:12px 0" onclick="startGame()" disabled>Need 2+</button>
      <button class="btn btn-ghost" style="padding:12px 18px" onclick="leaveLobby()">Leave</button>
    </div>
    <p id="lobbyWait" style="color:var(--text-muted);font-size:12px;margin-top:10px;display:none">Waiting for host‚Ä¶</p>
  </div>
</div>
<div id="game" class="screen">
  <div class="top-bar">
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <span class="title">üÉè Hand &amp; Foot</span>
      <span class="badge badge-accent" id="roundBadge"></span>
      <span class="badge badge-code">Code: <strong id="gameCode"></strong></span>
    </div>
    <div class="top-btns">
      <button class="btn btn-ghost btn-sm" onclick="toggleLog()" title="Activity Log">üìù</button>
      <button class="btn btn-ghost btn-sm" onclick="showRules()">üìñ</button>
      <button class="btn btn-ghost btn-sm" onclick="showScores()">üìä</button>
      <button class="btn btn-ghost btn-sm" style="color:#FCA5A5" onclick="leaveGame()">‚úï</button>
    </div>
  </div>
  <div id="turnBanner" class="turn-banner"></div>
  <div id="playerTabs" class="player-tabs"></div>
  <div class="game-scroll" id="gameScroll">
    <div id="activityLog" class="activity-log"></div>
    <div id="pilesArea" class="piles-area"></div>
    <div id="myMelds" class="melds-section" style="display:none"></div>
    <div id="oppMelds" class="opp-melds" style="display:none"></div>
  </div>
  <div id="actionBar" class="action-bar" style="display:none"></div>
  <div id="handSection" class="hand-section"></div>
</div>
<div id="rulesModal" class="modal-overlay hidden" onclick="hideRules()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-title">üìñ How to Play</div>
    <div class="rules-text">
      <p><strong>Turn:</strong> Draw 2 from draw pile OR pick up 5 from discard. Meld cards. Discard 1 to end.</p>
      <p><strong>Discard Pickup:</strong> Take top 5 (rest from draw pile if &lt;5). Must meld the top card. Cannot pick up if: top card is wild, black 3, or you can't immediately meld it (need 2 matching in hand). Cannot pick up a rank you already have melded.</p>
      <p><strong>Melds:</strong> 3+ same rank. Naturals &gt; wilds. Max 3 wilds. No 3s. No all-wild melds. You can add cards to existing melds.</p>
      <p><strong>Multiple Melds:</strong> Play multiple per turn. Round minimum = combined total.</p>
      <p><strong>Books:</strong> 7+ cards = book. Clean (no wilds) +500. Dirty (wilds) +300.</p>
      <p><strong>Foot:</strong> Hand empties ‚Üí pick up foot, keep playing (no discard needed).</p>
      <p><strong>Going Out:</strong> 2 clean + 1 dirty book, in foot, discard last card. +100 bonus.</p>
      <p><strong>Red 3s:</strong> Auto-collected. +100 each if you go out or have melds. -100 each if stuck in hand.</p>
      <p><strong>Round Mins:</strong> R1:50, R2:90, R3:120, R4:150. Starting player rotates each round.</p>
      <p><strong>Scoring:</strong> Joker=50, 2/A=20, 8‚ÄìK=10, 4‚Äì7=5, 3=5. Cards left in hand/foot = penalty.</p>
      <p><strong>Decks:</strong> Number of players + 1.</p>
    </div>
    <div style="text-align:center;margin-top:12px"><button class="btn" onclick="hideRules()">Got It</button></div>
  </div>
</div>
<div id="scoresModal" class="modal-overlay hidden" onclick="hideScores()">
  <div class="modal-box" onclick="event.stopPropagation()"><div class="modal-title">üìä Scoreboard</div><div id="scoresContent"></div>
    <div style="text-align:center;margin-top:12px"><button class="btn" onclick="hideScores()">Close</button></div></div>
</div>
<div id="recapModal" class="modal-overlay hidden">
  <div class="modal-box" onclick="event.stopPropagation()"><div class="modal-title" id="recapTitle"></div><div id="recapContent"></div>
    <div id="recapBtns" style="display:flex;gap:10px;justify-content:center;margin-top:14px"></div></div>
</div>
<div id="gameoverOverlay" class="gameover-overlay hidden"></div>

<script>
const SUITS=["‚ô†","‚ô•","‚ô¶","‚ô£"],RANKS=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
const HAND_SIZE=11,BOOK_SIZE=7,MAX_WILDS=3,MIN_MELD=3,PICKUP=5;
const RMINS=[50,90,120,150];
const PTS={Joker:50,"2":20,A:20,K:10,Q:10,J:10,"10":10,"9":5,"8":5,"7":5,"6":5,"5":5,"4":5,"3":5};
// Sort: wilds first (Joker=0,2=1), then 3-K, Ace last
const SO={Joker:0,"2":1,"3":2,"4":3,"5":4,"6":5,"7":6,"8":7,"9":8,"10":9,J:10,Q:11,K:12,A:13};
const isW=c=>c.r==="Joker"||c.r==="2",isR3=c=>c.r==="3"&&(c.s==="‚ô•"||c.s==="‚ô¶"),isB3=c=>c.r==="3"&&(c.s==="‚ô†"||c.s==="‚ô£");
const cV=c=>c.r==="Joker"?50:(PTS[c.r]||5),cC=c=>c.r==="Joker"?"#8B5CF6":(c.s==="‚ô•"||c.s==="‚ô¶")?"#DC2626":"#1E293B";
const mR=cs=>{const n=cs.find(c=>!isW(c));return n?n.r:null};
let sortDir=1; // 1=low-high, -1=high-low
function sH(h){return[...h].sort((a,b)=>(SO[a.r]-SO[b.r])*sortDir)}

function canM(cs){
  if(cs.length<MIN_MELD)return false;
  const n=cs.filter(c=>!isW(c)),w=cs.filter(c=>isW(c));
  if(w.length>MAX_WILDS||!n.length||w.length>=n.length)return false;
  if(n[0].r==="3")return false;
  // All-wild melds not allowed
  if(n.length===0)return false;
  return n.every(c=>c.r===n[0].r);
}
function mP(cs){return cs.reduce((s,c)=>s+cV(c),0)}
function isCl(m){return m.length>=BOOK_SIZE&&m.every(c=>!isW(c))}
function isDr(m){return m.length>=BOOK_SIZE&&m.some(c=>isW(c))}
function isBook(m){return m.length>=BOOK_SIZE}

// Scoring with red 3 penalty
function cS(p,wentOut){
  let s=0;
  (p.melds||[]).forEach(m=>{s+=mP(m);if(isBook(m))s+=m.every(c=>!isW(c))?500:300});
  // Red 3s: +100 if player has melds, -100 if no melds
  const hasMelds=p.melds&&p.melds.length>0;
  s+=(p.red3s||[]).length*(hasMelds?100:-100);
  // Penalty for cards left in hand and foot
  s-=(p.hand||[]).reduce((a,c)=>a+cV(c),0);
  if(!p.inFoot)s-=(p.foot||[]).reduce((a,c)=>a+cV(c),0);
  return s;
}
function detailedScore(p,wentOut){
  let meldPts=0,bookBonus=0,cleanB=0,dirtyB=0;
  (p.melds||[]).forEach(m=>{meldPts+=mP(m);if(isBook(m)){if(m.every(c=>!isW(c))){bookBonus+=500;cleanB++}else{bookBonus+=300;dirtyB++}}});
  const hasMelds=p.melds&&p.melds.length>0;
  const r3pts=(p.red3s||[]).length*(hasMelds?100:-100);
  const handPen=(p.hand||[]).reduce((a,c)=>a+cV(c),0);
  const footPen=p.inFoot?0:(p.foot||[]).reduce((a,c)=>a+cV(c),0);
  const goOut=wentOut?100:0;
  const total=meldPts+bookBonus+r3pts-handPen-footPen+goOut;
  return{meldPts,bookBonus,cleanB,dirtyB,r3pts,r3count:(p.red3s||[]).length,handPen,footPen,goOut,total};
}
function mkD(n){const cs=[];let id=0;for(let d=0;d<n;d++){for(const s of SUITS)for(const r of RANKS)cs.push({r,s,id:id++});cs.push({r:"Joker",s:"üÉè",id:id++});cs.push({r:"Joker",s:"üÉè",id:id++})}return cs}
function sh(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b}
function initR(names,startPI){
  const n=names.length,nd=n+1; // decks = players + 1
  let dk=sh(mkD(nd));
  const ps=names.map(nm=>{const h=dk.splice(0,HAND_SIZE),f=dk.splice(0,HAND_SIZE),r3=h.filter(isR3),cl=h.filter(c=>!isR3(c)),rp=dk.splice(0,r3.length);
    return{name:nm,hand:sH([...cl,...rp]),foot:f,inFoot:false,melds:[],red3s:r3,hasInit:false}});
  return{players:ps,drawPile:dk,discardPile:[dk.pop()],curPI:startPI||0,phase:"draw",drawn:false,turnMP:0,mustId:null,newIds:null}}

let peer=null,conns=[],myName="",myIdx=-1,isHost=false,roomCode="",maxPlayers=4,numRounds=4,selTheme="classic",cardBackUrl="";
let lobbyPlayers=[],GS=null,myView=null,selectedIds=new Set();
let newCardIds=new Set(),newCardTimer=null,actLog=[],logVisible=false;
let prevTurnPI=-1; // track turn changes for notifications

function genC(){const ch="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let c="";for(let i=0;i<6;i++)c+=ch[Math.floor(Math.random()*ch.length)];return c}
function pid(c){return"handf-"+c.toLowerCase()}
function setupP(id){return new Promise((r,j)=>{peer=new Peer(id,{debug:0});peer.on('open',()=>r());peer.on('error',e=>{if(e.type==='unavailable-id')j(new Error('Code in use.'));else if(e.type==='peer-unavailable')j(new Error('Game not found.'));else j(e)})})}
function hostListen(){peer.on('connection',cn=>{cn.on('open',()=>{cn.on('data',d=>hostMsg(cn,d))});cn.on('close',()=>{conns=conns.filter(c=>c!==cn);updateLobby()})})}
function hostMsg(cn,msg){
  if(msg.type==='join'){
    if(GS){cn.send({type:'error',msg:'Game in progress.'});cn.close();return}
    if(lobbyPlayers.length>=maxPlayers){cn.send({type:'error',msg:'Game full.'});cn.close();return}
    if(lobbyPlayers.some(p=>p.name.toLowerCase()===msg.name.toLowerCase())){cn.send({type:'error',msg:'Name taken.'});cn.close();return}
    const idx=lobbyPlayers.length;cn._pi=idx;cn._pn=msg.name;conns.push(cn);
    lobbyPlayers.push({name:msg.name,idx});
    cn.send({type:'joined',idx,names:lobbyPlayers.map(p=>p.name),maxPlayers,numRounds,theme:selTheme,cardBackUrl});
    bLobby();updateLobby();
  }else if(msg.type==='action'&&GS){hAct(cn._pi,msg)}
  else if(msg.type==='recapAck'&&GS&&GS.awaitingRecap){handleRecapAck(cn._pi,msg)}
}
function bLobby(){conns.forEach(c=>c.send({type:'lobby',names:lobbyPlayers.map(p=>p.name),maxPlayers,numRounds}))}
function bViews(){if(!GS)return;conns.forEach(c=>{if(c._pi!=null&&c._pi<GS.players.length)c.send({type:'view',view:mkV(c._pi)})});myView=mkV(0);GS.newIds=null;renderGame()}
function mkV(i){const p=GS.players[i];
  // Compute live scores for all players
  const liveScores=GS.players.map(pp=>{let s=0;(pp.melds||[]).forEach(m=>{s+=mP(m);if(isBook(m))s+=m.every(c=>!isW(c))?500:300});s+=(pp.red3s||[]).length*100;return s});
  // Hand/foot counts for opponents
  const handCounts=GS.players.map(pp=>({hand:pp.hand.length,foot:pp.foot.length,inFoot:pp.inFoot}));
  return{hand:p.hand,foot:p.foot,inFoot:p.inFoot,melds:p.melds,red3s:p.red3s,hasInit:p.hasInit,
    curPI:GS.curPI,phase:GS.phase,drawn:GS.drawn,discardPile:GS.discardPile,drawCount:GS.drawPile.length,
    allMelds:GS.players.map(pp=>pp.melds),allNames:GS.players.map(pp=>pp.name),
    roundScores:GS.roundScores,curRound:GS.curRound,numRounds:GS.numRounds,
    lastAction:GS.lastAction||"",myIdx:i,isGameOver:GS.isGameOver||false,
    turnMP:GS.curPI===i?(GS.turnMP||0):0,mustId:GS.curPI===i?GS.mustId:null,
    newIds:GS.curPI===i?(GS.newIds||null):null,theme:selTheme,cardBackUrl,
    liveScores,handCounts,actLog:actLog.slice(-20)}}
function clConn(code,name){return new Promise((r,j)=>{const cn=peer.connect(pid(code),{reliable:true});cn.on('open',()=>{cn.send({type:'join',name});cn.on('data',d=>clMsg(d,r,j));conns=[cn]});cn.on('error',e=>j(e));setTimeout(()=>j(new Error('Timed out.')),12000)})}
function clMsg(msg,jR,jJ){
  if(msg.type==='joined'){myIdx=msg.idx;lobbyPlayers=msg.names.map((n,i)=>({name:n,idx:i}));maxPlayers=msg.maxPlayers;numRounds=msg.numRounds;if(msg.theme)aTheme(msg.theme);if(msg.cardBackUrl)setCB(msg.cardBackUrl);if(jR)jR();jR=null;updateLobby()}
  else if(msg.type==='lobby'){lobbyPlayers=msg.names.map((n,i)=>({name:n,idx:i}));updateLobby()}
  else if(msg.type==='start'){if(msg.theme)aTheme(msg.theme);if(msg.cardBackUrl)setCB(msg.cardBackUrl);myView=msg.view;showScr('game');renderGame()}
  else if(msg.type==='view'){myView=msg.view;renderGame()}
  else if(msg.type==='error'){showErr(msg.msg);if(jJ)jJ(new Error(msg.msg))}
  else if(msg.type==='toast'){toast(msg.msg)}
  else if(msg.type==='bigtoast'){bigToast(msg.msg)}
  else if(msg.type==='recap'){showRecap(msg.data)}
}
function sAct(a){if(isHost)hAct(0,{type:'action',...a});else if(conns[0])conns[0].send({type:'action',...a})}

function addLog(msg){actLog.push(msg);if(actLog.length>50)actLog.shift()}

// ‚ïê‚ïê‚ïê HOST ACTIONS ‚ïê‚ïê‚ïê
function hAct(pi,msg){
  if(!GS||GS.isGameOver||GS.awaitingRecap)return;
  if(pi!==GS.curPI){sT(pi,"Not your turn!");return}
  const p=GS.players[pi],a=msg.action;
  if(a==='drawPile'){
    if(GS.phase!=='draw'||GS.drawn)return;
    if(GS.drawPile.length<2){const np=sh(GS.discardPile.slice(0,-1)),top=GS.discardPile[GS.discardPile.length-1];GS.drawPile=np;GS.discardPile=[top];addLog("Draw pile reshuffled");GS.lastAction="Reshuffled";bViews();return}
    const c1=GS.drawPile.pop(),c2=GS.drawPile.pop();let h=[...(p.inFoot?p.foot:p.hand),c1,c2];
    const r3=h.filter(isR3),cl=h.filter(c=>!isR3(c)),rp=GS.drawPile.splice(0,r3.length);h=sH([...cl,...rp]);
    if(p.inFoot)p.foot=h;else p.hand=h;p.red3s=[...p.red3s,...r3];
    GS.phase="play";GS.drawn=true;GS.mustId=null;GS.newIds=[c1.id,c2.id];
    addLog(p.name+" drew 2");GS.lastAction=p.name+" drew 2";bViews();
  }
  else if(a==='pickupDiscard'){
    if(GS.phase!=='draw'||GS.drawn)return;
    if(!GS.discardPile.length){sT(pi,"Discard empty!");return}
    const top=GS.discardPile[GS.discardPile.length-1];
    if(isB3(top)){sT(pi,"Black 3 blocks pickup!");return}
    if(isW(top)){sT(pi,"Can't pick up wild cards!");return}
    // Can't pick up rank already melded
    if(p.melds.some(m=>mR(m)===top.r)){sT(pi,"Already melded "+top.r+"!");return}
    // Must have 2 of that rank in hand to immediately meld
    const hand=p.inFoot?p.foot:p.hand;
    const matchCount=hand.filter(c=>c.r===top.r).length;
    const wildCount=hand.filter(c=>isW(c)).length;
    if(matchCount+wildCount<2||matchCount<1){sT(pi,"Need 2 matching cards to pick up!");return}
    const fromD=GS.discardPile.splice(-Math.min(PICKUP,GS.discardPile.length));
    let extra=[];if(fromD.length<PICKUP){const need=PICKUP-fromD.length;extra=GS.drawPile.splice(-Math.min(need,GS.drawPile.length))}
    const picked=[...fromD,...extra],topC=fromD[fromD.length-1];
    let h=[...(p.inFoot?p.foot:p.hand),...picked];const r3=h.filter(isR3);h=sH(h.filter(c=>!isR3(c)));
    if(p.inFoot)p.foot=h;else p.hand=h;p.red3s=[...p.red3s,...r3];
    GS.phase="play";GS.drawn=true;GS.mustId=topC.id;GS.newIds=picked.map(c=>c.id);
    addLog(p.name+` picked up ${picked.length} (must meld ${topC.r})`);
    GS.lastAction=p.name+` picked up ${picked.length} (must meld ${topC.r})`;bViews();
  }
  else if(a==='meld'){
    if(GS.phase!=='play')return;const h=p.inFoot?p.foot:p.hand,ids=new Set(msg.cardIds),sel=h.filter(c=>ids.has(c.id));
    if(!canM(sel)){sT(pi,"Invalid meld!");return}const r=mR(sel);
    // If existing meld of same rank, add to it instead
    const existIdx=p.melds.findIndex(m=>mR(m)===r);
    if(existIdx>=0){
      // Redirect to addToMeld
      return hAct(pi,{type:'action',action:'addToMeld',cardIds:msg.cardIds,meldIdx:existIdx});
    }
    const rem=h.filter(c=>!ids.has(c.id));if(p.inFoot)p.foot=rem;else p.hand=rem;p.melds.push(sel);
    if(GS.mustId&&sel.some(c=>c.id===GS.mustId))GS.mustId=null;
    if(!p.hasInit){GS.turnMP=(GS.turnMP||0)+mP(sel);const rm=RMINS[Math.min(GS.curRound,3)];
      if(GS.turnMP>=rm){p.hasInit=true;addLog(p.name+" melded "+r+" ‚Äî minimum met!");GS.lastAction=p.name+" melded "+r+" ‚Äî minimum met! ‚úÖ"}
      else{addLog(p.name+" melded "+r+` (${GS.turnMP}/${rm})`);GS.lastAction=p.name+" melded "+r+` (${GS.turnMP}/${rm})`}}
    else{addLog(p.name+" melded "+r);GS.lastAction=p.name+" melded "+r}
    sortMelds(p);chkFoot(p,pi);bViews();
  }
  else if(a==='addToMeld'){
    if(GS.phase!=='play')return;const h=p.inFoot?p.foot:p.hand,ids=new Set(msg.cardIds),sel=h.filter(c=>ids.has(c.id));
    if(!sel.length){sT(pi,"Select cards!");return}const mi=msg.meldIdx;if(mi<0||mi>=p.melds.length)return;
    const comb=[...p.melds[mi],...sel],nat=comb.filter(c=>!isW(c)),wld=comb.filter(c=>isW(c));
    if(wld.length>MAX_WILDS){sT(pi,"Max 3 wilds!");return}if(wld.length>=nat.length){sT(pi,"Need more naturals!");return}
    const r=mR(p.melds[mi]);if(sel.filter(c=>!isW(c)).some(c=>c.r!==r)){sT(pi,"Must match "+r+"!");return}
    const rem=h.filter(c=>!ids.has(c.id));if(p.inFoot)p.foot=rem;else p.hand=rem;p.melds[mi]=comb;
    if(GS.mustId&&sel.some(c=>c.id===GS.mustId))GS.mustId=null;
    if(!p.hasInit){GS.turnMP=(GS.turnMP||0)+mP(sel);if(GS.turnMP>=RMINS[Math.min(GS.curRound,3)])p.hasInit=true}
    addLog(p.name+" added "+sel.length+" to "+r);GS.lastAction=p.name+" added to "+r;
    sortMelds(p);chkFoot(p,pi);bViews();
  }
  else if(a==='undoMelds'){
    if(GS.phase!=='play'||p.hasInit){sT(pi,"Can't undo.");return}if(!p.melds.length){sT(pi,"Nothing to undo.");return}
    const ret=p.melds.flat();let h=[...(p.inFoot?p.foot:p.hand),...ret];if(p.inFoot)p.foot=sH(h);else p.hand=sH(h);
    p.melds=[];GS.turnMP=0;addLog(p.name+" undid melds");GS.lastAction=p.name+" undid melds";bViews();
  }
  else if(a==='discard'){
    if(GS.phase!=='play')return;
    if(GS.mustId){const h=p.inFoot?p.foot:p.hand;if(h.some(c=>c.id===GS.mustId)){sT(pi,"Must meld the discard card first!");return}}
    if(!p.hasInit&&(GS.turnMP||0)>0){sT(pi,`Need ${RMINS[Math.min(GS.curRound,3)]} pts (have ${GS.turnMP}). Meld more!`);return}
    const h=p.inFoot?p.foot:p.hand,card=h.find(c=>c.id===msg.cardId);
    if(!card){sT(pi,"Card not in hand!");return}
    const rem=h.filter(c=>c.id!==card.id);if(p.inFoot)p.foot=rem;else p.hand=rem;
    GS.discardPile.push(card);
    const curH=p.inFoot?p.foot:p.hand;
    // Going out check: 2 clean + 1 dirty
    if(curH.length===0&&p.inFoot){const cb=p.melds.filter(m=>isCl(m)).length,db=p.melds.filter(m=>isDr(m)).length;
      if(cb>=2&&db>=1){addLog(p.name+" went out! üèÜ");endRound(pi);return}}
    if(rem.length===0&&!p.inFoot){
      p.inFoot=true;addLog(p.name+" picks up Foot! ü¶∂");GS.lastAction=p.name+" picks up Foot! ü¶∂";
      bcastBigToast(p.name+" picks up Foot! ü¶∂");
      bViews();return; // continue turn in foot, don't advance
    }
    addLog(p.name+" discarded "+card.r);GS.lastAction=p.name+" discarded";
    GS.curPI=(GS.curPI+1)%GS.players.length;GS.phase="draw";GS.drawn=false;GS.turnMP=0;GS.mustId=null;GS.newIds=null;
    bViews();
  }
}
function sT(pi,m){if(pi===0)toast(m);else{const c=conns.find(c=>c._pi===pi);if(c)c.send({type:'toast',msg:m})}}
function bcastBigToast(m){bigToast(m);conns.forEach(c=>c.send({type:'bigtoast',msg:m}))}

function sortMelds(p){
  // Open melds sorted by rank, completed books at end
  p.melds.sort((a,b)=>{const aB=isBook(a),bB=isBook(b);if(aB!==bB)return aB?1:-1;return(SO[mR(a)]||0)-(SO[mR(b)]||0)});
}

function chkFoot(p,pi){
  const h=p.inFoot?p.foot:p.hand;
  if(!h.length&&!p.inFoot){
    p.inFoot=true;addLog(p.name+" picks up Foot! ü¶∂");GS.lastAction=p.name+" picks up Foot! ü¶∂";
    bcastBigToast(p.name+" picks up Foot! ü¶∂");
    // Continue playing from foot - no discard needed
  }
}

function endRound(goIdx){
  const details=GS.players.map((p,i)=>detailedScore(p,i===goIdx));
  const scores=details.map(d=>d.total);
  GS.roundScores=GS.roundScores.map((rs,i)=>[...rs,scores[i]]);GS.curRound++;
  // Send recap to all
  const recapData={round:GS.curRound,goer:GS.players[goIdx].name,details,names:GS.players.map(p=>p.name),
    roundScores:GS.roundScores,isLast:GS.curRound>=GS.numRounds};
  GS.awaitingRecap=true;
  conns.forEach(c=>c.send({type:'recap',data:recapData}));
  showRecap(recapData);
}

function handleRecapAck(pi,msg){
  if(msg.cont==='end'||GS.curRound>=GS.numRounds){
    GS.isGameOver=true;GS.awaitingRecap=false;GS.lastAction="Game over! üèÜ";bViews();
  } else {
    GS.awaitingRecap=false;
    const startPI=GS.curRound%GS.players.length; // rotate starting player
    const ns=initR(GS.players.map(p=>p.name),startPI);
    const ss=GS.roundScores,cr=GS.curRound,nr=GS.numRounds;
    Object.assign(GS,ns);GS.roundScores=ss;GS.curRound=cr;GS.numRounds=nr;GS.isGameOver=false;GS.awaitingRecap=false;
    addLog(`Round ${cr+1} begins ‚Äî ${GS.players[startPI].name} starts`);
    GS.lastAction=`Round ${cr+1} ‚Äî min ${RMINS[Math.min(cr,3)]} ‚Äî ${GS.players[startPI].name} starts`;
    bViews();
  }
}

// ‚ïê‚ïê‚ïê RECAP ‚ïê‚ïê‚ïê
function showRecap(data){
  document.getElementById('recapModal').classList.remove('hidden');
  document.getElementById('recapTitle').textContent=data.isLast?'üèÜ Final Round Complete!':`üìä Round ${data.round} Complete`;
  let h=`<p style="text-align:center;color:var(--text-dim);margin-bottom:12px">${data.goer} went out!</p><div class="recap-section">`;
  data.names.forEach((n,i)=>{const d=data.details[i];
    h+=`<div class="recap-player"><div class="recap-name" style="color:var(--accent)">${n}${d.goOut?' üèÜ':''}</div>
      <div class="recap-detail"><span>Meld points</span><span class="recap-pos">+${d.meldPts}</span></div>
      <div class="recap-detail"><span>Book bonuses (üìï${d.cleanB} üìò${d.dirtyB})</span><span class="recap-pos">+${d.bookBonus}</span></div>
      <div class="recap-detail"><span>Red 3s (${d.r3count})</span><span class="${d.r3pts>=0?'recap-pos':'recap-neg'}">${d.r3pts>=0?'+':''}${d.r3pts}</span></div>
      ${d.handPen?`<div class="recap-detail"><span>Hand penalty</span><span class="recap-neg">-${d.handPen}</span></div>`:''}
      ${d.footPen?`<div class="recap-detail"><span>Foot penalty</span><span class="recap-neg">-${d.footPen}</span></div>`:''}
      ${d.goOut?`<div class="recap-detail"><span>Going out bonus</span><span class="recap-pos">+100</span></div>`:''}
      <div class="recap-total">Round: ${d.total} | Total: ${(data.roundScores[i]||[]).reduce((a,b)=>a+b,0)}</div></div>`});
  h+='</div>';
  document.getElementById('recapContent').innerHTML=h;
  const btns=document.getElementById('recapBtns');
  if(isHost){
    if(data.isLast) btns.innerHTML=`<button class="btn btn-gold" onclick="recapContinue('end')">Finish Game</button>`;
    else btns.innerHTML=`<button class="btn btn-gold" onclick="recapContinue('next')">Next Round</button><button class="btn btn-red" onclick="recapContinue('end')">End Game</button>`;
  } else btns.innerHTML=`<p style="color:var(--text-muted);font-size:12px">Waiting for host‚Ä¶</p>`;
}
window.recapContinue=function(choice){
  document.getElementById('recapModal').classList.add('hidden');
  if(isHost)handleRecapAck(0,{cont:choice});
};

// ‚ïê‚ïê‚ïê THEMES ‚ïê‚ïê‚ïê
const TH=[{id:'classic',nm:'Classic',c:['#132B18','#0A1210','#EAB308']},{id:'vegas',nm:'Vegas',c:['#1F0A30','#12051A','#FF3CAC']},{id:'royal',nm:'Royal',c:['#0C1A34','#060C18','#A0C4FF']},{id:'crimson',nm:'Crimson',c:['#2A1010','#140808','#FFB347']}];
function aTheme(t){document.body.className='';if(t!=='classic')document.body.classList.add('theme-'+t);selTheme=t}
function setCB(url){cardBackUrl=url;document.documentElement.style.setProperty('--card-back-img',url?`url(${url})`:'none')}

// ‚ïê‚ïê‚ïê UI ‚ïê‚ïê‚ïê
function showScr(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active')}
function showErr(m){const e=document.getElementById('homeError');e.textContent=m;e.style.display='block';setTimeout(()=>e.style.display='none',4000)}
let tt;function toast(m){const e=document.getElementById('toast');e.textContent=m;e.classList.remove('hidden');clearTimeout(tt);tt=setTimeout(()=>e.classList.add('hidden'),3500)}
let btt;function bigToast(m){const e=document.getElementById('bigToast');e.textContent=m;e.classList.add('show');clearTimeout(btt);btt=setTimeout(()=>e.classList.remove('show'),2500)}
function showHomeBtns(){document.getElementById('homeButtons').style.display='flex';document.getElementById('hostOpts').style.display='none';document.getElementById('joinOpts').style.display='none'}
function showHostOpts(){document.getElementById('homeButtons').style.display='none';document.getElementById('hostOpts').style.display='block';renderSetup()}
function showJoinOpts(){document.getElementById('homeButtons').style.display='none';document.getElementById('joinOpts').style.display='block'}
function copyCode(){navigator.clipboard.writeText(roomCode).then(()=>{document.getElementById('copyHint').textContent='‚úì Copied!';setTimeout(()=>document.getElementById('copyHint').textContent='Tap to copy',2000)}).catch(()=>{})}
function toggleLog(){logVisible=!logVisible;document.getElementById('activityLog').classList.toggle('visible',logVisible)}

function renderSetup(){
  let h='';for(let n=2;n<=8;n++)h+=`<button class="num-btn ${n===maxPlayers?'active':''}" onclick="maxPlayers=${n};renderSetup()">${n}</button>`;
  document.getElementById('playerBtns').innerHTML=h;
  let r='';for(let n=1;n<=4;n++)r+=`<button class="num-btn ${n===numRounds?'active':''}" style="width:auto;padding:8px 14px;font-family:var(--font-body);font-size:13px" onclick="numRounds=${n};renderSetup()">${n}</button>`;
  document.getElementById('roundBtns').innerHTML=r;
  let t='';TH.forEach(th=>{t+=`<div class="theme-btn ${selTheme===th.id?'active':''}" onclick="selTheme='${th.id}';aTheme('${th.id}');renderSetup()"><div class="swatch" style="background:linear-gradient(135deg,${th.c[0]},${th.c[1]});border:1px solid ${th.c[2]}40"></div>${th.nm}</div>`});
  document.getElementById('themeBtns').innerHTML=t;
}
function updateLobby(){
  document.getElementById('lobbyCode').textContent=roomCode;document.getElementById('playerCount').textContent=`(${lobbyPlayers.length}/${maxPlayers})`;
  let h='';lobbyPlayers.forEach((p,i)=>{const me=i===myIdx;h+=`<div class="player-slot ${me?'me':''}"><div class="player-avatar" style="background:hsl(${i*47+20},50%,40%)">${p.name[0].toUpperCase()}</div><div style="flex:1"><div style="font-size:13px;font-weight:600">${p.name} ${me?'<span style="color:#64748B;font-size:10px">(you)</span>':''}</div>${i===0?'<div style="color:var(--accent);font-size:10px;font-weight:600">HOST</div>':''}</div><div style="width:8px;height:8px;border-radius:4px;background:var(--success)"></div></div>`});
  for(let i=0;i<maxPlayers-lobbyPlayers.length;i++)h+=`<div class="player-slot empty"><div class="player-avatar" style="background:rgba(255,255,255,.04);color:#4A5568">?</div><div style="color:#4A5568;font-size:12px;flex:1">Waiting‚Ä¶</div></div>`;
  document.getElementById('playerSlots').innerHTML=h;
  const sb=document.getElementById('startBtn');
  if(isHost){sb.style.display='block';sb.disabled=lobbyPlayers.length<2;sb.textContent=lobbyPlayers.length<2?'Need 2+':'Start Game';document.getElementById('lobbyWait').style.display='none'}
  else{sb.style.display='none';document.getElementById('lobbyWait').style.display='block'}
}

// ‚ïê‚ïê‚ïê CARDS ‚ïê‚ïê‚ïê
function rC(c,o={}){const col=cC(c),j=c.r==="Joker",s=o.selected?'selected':'',sm=o.small?'sm':'',mp=o.must?'must-play':'',nw=o.isNew?'new-card':'',cl=o.onClick||'';
  return`<div class="card ${s} ${sm} ${mp} ${nw}" ${cl?`onclick="${cl}"`:''} style="color:${col}"><div class="card-rank">${j?'‚òÖ':c.r}</div><div class="card-suit-sm">${j?'':c.s}</div><div class="card-suit-lg">${j?'üÉè':c.s}</div></div>`}
function rB(o={}){const sm=o.small?'sm':'',cl=o.clickable?'clickable':'',hl=o.hl?'hl':'',hi=cardBackUrl?'has-img':'',oc=o.onClick||'';
  return`<div class="card-back ${sm} ${cl} ${hl} ${hi}" ${oc?`onclick="${oc}"`:''} ><div class="card-back-inner"></div></div>`}

// ‚ïê‚ïê‚ïê DRAG SCROLL ‚ïê‚ïê‚ïê
function enableDragScroll(el){
  let isDown=false,startX,scrollL;
  el.addEventListener('mousedown',e=>{if(e.target.closest('.card,.meld-add-btn'))return;isDown=true;el.style.cursor='grabbing';startX=e.pageX-el.offsetLeft;scrollL=el.scrollLeft});
  el.addEventListener('mouseleave',()=>{isDown=false;el.style.cursor='grab'});
  el.addEventListener('mouseup',()=>{isDown=false;el.style.cursor='grab'});
  el.addEventListener('mousemove',e=>{if(!isDown)return;e.preventDefault();el.scrollLeft=scrollL-(e.pageX-el.offsetLeft-startX)});
  // Touch
  let tStartX,tScrollL;
  el.addEventListener('touchstart',e=>{tStartX=e.touches[0].pageX;tScrollL=el.scrollLeft},{passive:true});
  el.addEventListener('touchmove',e=>{if(tStartX==null)return;el.scrollLeft=tScrollL-(e.touches[0].pageX-tStartX)},{passive:true});
}
// Arrow key scroll
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft'||e.key==='ArrowRight'){
    const fan=document.querySelector('.hand-fan');if(fan)fan.scrollLeft+=e.key==='ArrowRight'?80:-80;
  }
});

// ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê
function renderGame(){
  if(!myView)return;const v=myView,mi=v.myIdx!=null?v.myIdx:myIdx,isMT=v.curPI===mi,hand=v.inFoot?v.foot:v.hand;
  if(v.newIds&&v.newIds.length){v.newIds.forEach(id=>newCardIds.add(id));clearTimeout(newCardTimer);newCardTimer=setTimeout(()=>{newCardIds.clear();renderGame()},4000)}
  // Turn change notification
  if(v.curPI===mi&&prevTurnPI!==mi&&prevTurnPI!==-1){toast("üéØ Your turn!");try{if(document.hidden&&window.Notification&&Notification.permission==='granted')new Notification("Hand & Foot",{body:"Your turn!"})}catch(e){}}
  prevTurnPI=v.curPI;
  const myM=v.allMelds[mi]||[],rm=RMINS[Math.min(v.curRound,3)];
  const cB=myM.filter(m=>isCl(m)).length,dB=myM.filter(m=>isDr(m)).length,canGo=v.inFoot&&cB>=2&&dB>=1;
  if(v.theme&&v.theme!==selTheme)aTheme(v.theme);if(v.cardBackUrl&&v.cardBackUrl!==cardBackUrl)setCB(v.cardBackUrl);
  document.getElementById('roundBadge').textContent=`R${v.curRound+1}/${v.numRounds} ¬∑ Min ${rm}`;
  document.getElementById('gameCode').textContent=roomCode;
  // Activity log
  if(v.actLog){const al=document.getElementById('activityLog');al.innerHTML=v.actLog.map(l=>`<div class="log-entry">${l}</div>`).join('')}
  // Turn banner
  const tb=document.getElementById('turnBanner');tb.className='turn-banner'+(isMT?' mine':'');
  tb.innerHTML=`<div class="who" style="color:${isMT?'var(--accent)':'var(--text-dim)'}">${isMT?'‚ú® YOUR TURN ‚ú®':'‚è≥ '+v.allNames[v.curPI]+"'s Turn"}</div>${isMT?`<span class="phase" style="color:${v.phase==='draw'?'var(--success)':'var(--accent)'}">${v.phase==='draw'?'üì• DRAW':'üé¥ PLAY & DISCARD'}</span>`:''}${v.lastAction?`<div class="last">${v.lastAction}</div>`:''}`;
  // Player tabs with scores and card counts
  let tabs='';v.allNames.forEach((n,i)=>{const cls=i===v.curPI?'current':(i===mi?'me':'');const hc=v.handCounts?v.handCounts[i]:null;
    const ls=v.liveScores?v.liveScores[i]:0;const total=(v.roundScores[i]||[]).reduce((a,b)=>a+b,0)+ls;
    tabs+=`<div class="ptab ${cls}">${n}${i===mi?' üë§':''}${i===v.curPI?' üéØ':''}
      <span class="pts">${total}pts</span>
      ${hc&&i!==mi?`<span class="cnt">${hc.inFoot?'ü¶∂':'ü§ö'}${hc.inFoot?hc.foot:hc.hand}</span>`:''}</div>`});
  document.getElementById('playerTabs').innerHTML=tabs;
  // Piles
  let pl='<div class="pile-col"><div class="pile-label">DRAW ('+v.drawCount+')</div>';
  if(isMT&&v.phase==='draw'&&!v.drawn){pl+=rB({clickable:true,hl:true,onClick:"sAct({action:'drawPile'})"});pl+='<div class="pile-hint green">Draw 2</div>'}else pl+=rB({});
  pl+='</div><div class="pile-col"><div class="pile-label">DISCARD ('+v.discardPile.length+')</div>';
  if(v.discardPile.length){const top=v.discardPile[v.discardPile.length-1];
    const canPickup=isMT&&v.phase==='draw'&&!v.drawn&&!isB3(top)&&!isW(top);
    if(canPickup){pl+=`<div onclick="sAct({action:'pickupDiscard'})" style="cursor:pointer">${rC(top)}</div><div class="pile-hint blue">Pick up 5</div>`}
    else if(isMT&&v.phase==='draw'&&!v.drawn&&isW(top)){pl+=rC(top);pl+='<div class="pile-hint red">Wild ‚Äî can\'t pick up</div>'}
    else pl+=rC(top)}
  else pl+='<div class="empty-pile">Empty</div>';
  pl+='</div><div class="pile-col"><div class="pile-label">'+(v.inFoot?'IN FOOT ü¶∂':'FOOT')+'</div>';
  if(!v.inFoot)pl+=rB({});else pl+='<div class="foot-active">ü¶∂</div>';
  pl+='</div><div class="status-box"><div class="status-label">STATUS</div><div class="stat-row">';
  pl+=`<span class="stat stat-clean">üìï Clean: ${cB}</span><span class="stat stat-dirty">üìò Dirty: ${dB}</span></div>`;
  if(canGo)pl+='<div class="can-go-out">‚ú® You can go out!</div>';
  if(v.mustId)pl+='<div class="must-meld-warn">‚ö†Ô∏è Must meld discard card!</div>';
  if(!v.hasInit){const tp=v.turnMP||0;if(tp>0){const pc=Math.min(100,Math.round(tp/rm*100));
    pl+=`<div style="margin-top:4px;font-size:10px;color:#F59E0B;background:rgba(245,158,11,.1);padding:3px 6px;border-radius:5px">‚ö†Ô∏è ${tp}/${rm}<div style="margin-top:2px;height:3px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden"><div style="height:100%;width:${pc}%;background:var(--accent);border-radius:2px"></div></div></div>`}
    else pl+=`<div style="margin-top:4px;font-size:10px;color:#64748B;background:rgba(255,255,255,.03);padding:2px 6px;border-radius:5px">üîì Need ${rm}</div>`}
  pl+='</div>';document.getElementById('pilesArea').innerHTML=pl;
  // My melds ‚Äî open melds then completed books as stacks
  const ms=document.getElementById('myMelds');
  const openM=myM.filter(m=>!isBook(m)),books=myM.filter(m=>isBook(m));
  if(myM.length){ms.style.display='block';let mh='<div class="label">YOUR MELDS</div><div class="melds-row" id="myMeldsRow">';
    openM.forEach((m,oi)=>{const idx=myM.indexOf(m);const r=mR(m);
      mh+=`<div class="meld-card"><div class="meld-header"><span class="meld-rank" style="color:#94A3B8">${r||'W'}</span><span class="meld-count">(${m.length})</span></div><div class="meld-cards-row">`;
      const ov75=Math.round(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-w-sm'))*.75);
      m.forEach((c,ci)=>{mh+=`<div style="margin-left:${ci?-ov75:0}px">${rC(c,{small:true})}</div>`});
      mh+='</div>';if(isMT&&v.phase==='play'&&selectedIds.size)mh+=`<button class="meld-add-btn" onclick="doAdd(${idx})">+ Add</button>`;mh+='</div>'});
    // Books as compact stacks
    books.forEach((m)=>{const idx=myM.indexOf(m);const r=mR(m),cl=isCl(m);
      mh+=`<div class="book-stack ${cl?'clean':'dirty'}" title="${r} book (${m.length})">${cl?'üìï':'üìò'} ${r}<div class="bcount">${m.length}</div></div>`});
    mh+='</div>';ms.innerHTML=mh;
    setTimeout(()=>{const row=document.getElementById('myMeldsRow');if(row)enableDragScroll(row)},0);
  }else ms.style.display='none';
  // Opp melds
  const os=document.getElementById('oppMelds');const hasO=v.allNames.some((n,i)=>i!==mi&&v.allMelds[i]&&v.allMelds[i].length);
  if(hasO){os.style.display='block';let oh='<div class="label">OPPONENTS\' MELDS</div>';
    v.allNames.forEach((n,i)=>{if(i===mi||!v.allMelds[i]||!v.allMelds[i].length)return;
      const ocb=v.allMelds[i].filter(m=>isCl(m)).length,odb=v.allMelds[i].filter(m=>isDr(m)).length;
      oh+=`<div class="opp-player-section"><div class="opp-player-name">${n} <span style="font-size:11px;font-weight:400;color:#64748B">üìï${ocb} üìò${odb}</span></div><div class="opp-melds-scroll" id="oppScroll_${i}">`;
      const openOpp=v.allMelds[i].filter(m=>!isBook(m)),bookOpp=v.allMelds[i].filter(m=>isBook(m));
      openOpp.forEach(m=>{const r=mR(m);
        oh+=`<div class="opp-meld-card"><div class="meld-header"><span class="meld-rank" style="color:#94A3B8">${r}</span><span class="meld-count">(${m.length})</span></div><div class="meld-cards-row">`;
        const ov75=Math.round(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-w-sm'))*.75);
        m.forEach((c,ci)=>{oh+=`<div style="margin-left:${ci?-ov75:0}px">${rC(c,{small:true})}</div>`});oh+='</div></div>'});
      bookOpp.forEach(m=>{const r=mR(m),cl=isCl(m);
        oh+=`<div class="book-stack ${cl?'clean':'dirty'}">${cl?'üìï':'üìò'} ${r}<div class="bcount">${m.length}</div></div>`});
      oh+='</div></div>'});
    os.innerHTML=oh;
    setTimeout(()=>{v.allNames.forEach((n,i)=>{const el=document.getElementById('oppScroll_'+i);if(el)enableDragScroll(el)})},0);
  }else os.style.display='none';
  // Actions
  const ab=document.getElementById('actionBar');
  if(isMT&&v.phase==='play'){ab.style.display='flex';
    ab.innerHTML=`<button class="btn btn-green btn-sm" ${selectedIds.size<3?'disabled':''} onclick="doMeld()">Meld (${selectedIds.size})</button><button class="btn btn-red btn-sm" ${selectedIds.size!==1?'disabled':''} onclick="doDiscard()">Discard</button><button class="btn btn-ghost btn-sm" onclick="selectedIds.clear();renderGame()">Clear</button>${!v.hasInit&&(v.turnMP||0)>0?'<button class="btn btn-sm" style="background:rgba(239,68,68,.12);color:#FCA5A5;border-color:rgba(239,68,68,.25)" onclick="sAct({action:\'undoMelds\'})">‚Ü© Undo</button>':''}`}else ab.style.display='none';
  // Hand
  const hs=document.getElementById('handSection');
  let hh=`<div class="hand-header"><div class="hand-label">üîí ${v.allNames[mi]}'s ${v.inFoot?'FOOT':'HAND'} ‚Äî ${hand.length} cards</div>`;
  if(selectedIds.size)hh+=`<div class="hand-sel">${selectedIds.size} sel</div>`;
  hh+=`<button class="sort-btn" onclick="sortDir*=-1;if(myView){const h=myView.inFoot?myView.foot:myView.hand;const s=sH(h);if(myView.inFoot)myView.foot=s;else myView.hand=s;renderGame()}">${sortDir===1?'A‚ÜíK':'K‚ÜíA'}</button></div>`;
  if(hand.length){const cw=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-w'))||64;
    const overlap=cw*.75; // 75% overlap
    hh+='<div class="hand-fan" id="handFan">';hand.forEach((c,i)=>{const ml=i===0?0:-Math.round(overlap);
      hh+=`<div style="margin-left:${ml}px;z-index:${i}">${rC(c,{selected:selectedIds.has(c.id),must:v.mustId&&c.id===v.mustId,isNew:newCardIds.has(c.id),onClick:`toggleSel(${c.id})`})}</div>`});
    hh+='</div>';
  }else hh+='<div class="hand-empty">'+(v.inFoot?'Empty ‚Äî discard or go out!':'Picking up foot‚Ä¶')+'</div>';
  hs.innerHTML=hh;
  setTimeout(()=>{const fan=document.getElementById('handFan');if(fan)enableDragScroll(fan)},0);
  // Game over
  const go=document.getElementById('gameoverOverlay');
  if(v.isGameOver){go.classList.remove('hidden');let gh=`<div style="text-align:center;max-width:420px"><div style="font-size:56px;margin-bottom:10px">üèÜ</div><div style="color:var(--accent);font-size:26px;font-family:var(--font-display);margin-bottom:8px">Game Over!</div><div style="margin-bottom:18px">`;
    v.allNames.forEach((n,i)=>{const tot=(v.roundScores[i]||[]).reduce((a,b)=>a+b,0);gh+=`<div style="font-size:16px;margin-bottom:3px;color:${i===mi?'var(--accent)':'var(--text-label)'};font-weight:${i===mi?700:400}">${n}: ${tot}</div>`});
    gh+=`</div><div style="display:flex;gap:10px;justify-content:center"><button class="btn" onclick="showScores()">Scores</button><button class="btn btn-gold" onclick="leaveGame()">Home</button></div></div>`;go.innerHTML=gh}else go.classList.add('hidden');
}

// ‚ïê‚ïê‚ïê ACTIONS ‚ïê‚ïê‚ïê
window.toggleSel=function(id){if(selectedIds.has(id))selectedIds.delete(id);else selectedIds.add(id);renderGame()};
window.doMeld=function(){sAct({action:'meld',cardIds:[...selectedIds]});selectedIds.clear()};
window.doAdd=function(mi){sAct({action:'addToMeld',cardIds:[...selectedIds],meldIdx:mi});selectedIds.clear()};
window.doDiscard=function(){if(selectedIds.size!==1)return;sAct({action:'discard',cardId:[...selectedIds][0]});selectedIds.clear()};

// ‚ïê‚ïê‚ïê FLOW ‚ïê‚ïê‚ïê
window.hostGame=async function(){myName=document.getElementById('nameInput').value.trim();if(!myName){showErr('Enter name');return}
  cardBackUrl=document.getElementById('cardBackInput').value.trim();if(cardBackUrl)setCB(cardBackUrl);roomCode=genC();
  try{await setupP(pid(roomCode))}catch(e){showErr(e.message);return}
  isHost=true;myIdx=0;lobbyPlayers=[{name:myName,idx:0}];hostListen();
  document.getElementById('connStatus').textContent='üü¢ Connected';document.getElementById('connStatus').className='conn-status conn-ok';showScr('lobby');updateLobby();
  try{if(window.Notification&&Notification.permission==="default")Notification.requestPermission()}catch(e){}};
window.joinGame=async function(){myName=document.getElementById('nameInput').value.trim();const code=document.getElementById('codeInput').value.trim().toUpperCase();
  if(!myName){showErr('Enter name');return}if(code.length!==6){showErr('Enter 6-char code');return}roomCode=code;
  try{await setupP(null);document.getElementById('connStatus').textContent='üü° Connecting‚Ä¶';document.getElementById('connStatus').className='conn-status conn-wait';showScr('lobby');
    await clConn(code,myName);document.getElementById('connStatus').textContent='üü¢ Connected';document.getElementById('connStatus').className='conn-status conn-ok';updateLobby();
    try{if(window.Notification&&Notification.permission==="default")Notification.requestPermission()}catch(e){}}
  catch(e){showErr(e.message||'Failed.');showScr('home');showHomeBtns()}};
window.startGame=function(){if(!isHost||lobbyPlayers.length<2)return;const ns=initR(lobbyPlayers.map(p=>p.name),0);
  GS={...ns,roundScores:lobbyPlayers.map(()=>[]),curRound:0,numRounds,isGameOver:false,lastAction:'',awaitingRecap:false};
  addLog("Game started! Round 1");
  conns.forEach(c=>{if(c._pi!=null)c.send({type:'start',view:mkV(c._pi),theme:selTheme,cardBackUrl})});myView=mkV(0);showScr('game');renderGame()};
window.leaveLobby=function(){if(peer)peer.destroy();peer=null;conns=[];showScr('home');showHomeBtns()};
window.leaveGame=function(){if(peer)peer.destroy();peer=null;conns=[];GS=null;myView=null;selectedIds.clear();newCardIds.clear();clearTimeout(newCardTimer);actLog=[];prevTurnPI=-1;
  document.getElementById('gameoverOverlay').classList.add('hidden');document.getElementById('recapModal').classList.add('hidden');showScr('home');showHomeBtns()};
window.showRules=()=>document.getElementById('rulesModal').classList.remove('hidden');
window.hideRules=()=>document.getElementById('rulesModal').classList.add('hidden');
window.showScores=function(){const v=myView;if(!v)return;const mi=v.myIdx!=null?v.myIdx:myIdx;
  let h='<table class="score-table"><thead><tr><th style="text-align:left">Player</th>';(v.roundScores[0]||[]).forEach((_,i)=>h+=`<th>R${i+1}</th>`);
  h+='<th style="color:var(--accent);font-weight:700">Total</th></tr></thead><tbody>';
  v.allNames.forEach((n,pi)=>{const me=pi===mi;h+=`<tr><td style="font-weight:${me?700:400};color:${me?'var(--accent)':'var(--text)'}">${n}${me?' (you)':''}</td>`;
    (v.roundScores[pi]||[]).forEach(s=>h+=`<td style="color:${s>=0?'#86EFAC':'#FCA5A5'}">${s}</td>`);
    h+=`<td style="color:var(--accent);font-weight:700;font-size:15px">${(v.roundScores[pi]||[]).reduce((a,b)=>a+b,0)}</td></tr>`});
  h+='</tbody></table>';document.getElementById('scoresContent').innerHTML=h;document.getElementById('scoresModal').classList.remove('hidden')};
window.hideScores=()=>document.getElementById('scoresModal').classList.add('hidden');
window.showHostOpts=showHostOpts;window.showJoinOpts=showJoinOpts;window.showHomeBtns=showHomeBtns;window.renderSetup=renderSetup;window.sAct=sAct;window.sH=sH;
renderSetup();
</script>
</body>
</html>
